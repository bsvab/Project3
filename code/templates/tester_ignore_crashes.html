<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Choropleth Map in Leaflet with Average</title>
    <!-- Load Leaflet from CDN -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
        #map { height: 100vh; }
    </style>
</head>
<body>

<div id="map"></div>

<script>
    // Define the bounds of Texas
    var texasBounds = L.latLngBounds(
        [25.8371, -106.6466], // Southwest coordinates of Texas
        [36.5007, -93.5083]  // Northeast coordinates of Texas
    );

    // Create a Leaflet map centered on Texas
    var map = L.map('map').fitBounds(texasBounds);

    // Add OpenStreetMap tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    // Function to calculate color based on value
    function getColor(value) {
        return value >= 10000 ? '#800026' :
               value >= 5000  ? '#BD0026' :
               value >= 1000  ? '#E31A1C' :
               value >= 500   ? '#FC4E2A' :
               value >= 100   ? '#FD8D3C' :
               value >= 50    ? '#FEB24C' :
               value >= 10    ? '#FED976' :
                                '#FFEDA0';
    }

    // Function to parse CSV data
    function parseCSV(csvData) {
        let dataset = [];
        // Split the CSV data into lines
        const lines = csvData.split('\n');
        // Iterate over each line
        lines.forEach(line => {
            // Split the line into comma-separated values
            const values = line.split(',');
            // Extract lat, lng, and value from the values array
            const lat = parseFloat(values[4]);
            const lng = parseFloat(values[3]);
            const value = parseFloat(values[1]);
            // Check if lat, lng, and value are valid numbers
            if (!isNaN(lat) && !isNaN(lng) && !isNaN(value)) {
                // Construct the data point object
                const dataPoint = { lat, lng, value };
                // Push the data point object to the dataset array
                dataset.push(dataPoint);
            }
        });
        return dataset;
    }


    // Function to read CSV file
    async function readCSVFile(url) {
        const response = await fetch(url);
        const data = await response.text();
        return parseCSV(data);
    }

    // Call the function to read the CSV file
    fetch('../../data/smaller_file_test_pressure_data.csv')
        .then(response => response.text())
        .then(data => parseCSV(data))
        .then(dataset => {
            // Now you have the dataset, you can use it here
            drawMapSquares(dataset);
        })
        .catch(error => {
            console.error('Error reading CSV:', error);
        });

    // Function to draw map squares based on the dataset
    function drawMapSquares(dataset) {
        // Calculate the number of squares needed
        var width = texasBounds.getEast() - texasBounds.getWest();
        var height = texasBounds.getNorth() - texasBounds.getSouth();

        // Calculate number of squares horizontally and vertically
        var numHorizontalSquares = Math.ceil(width / (5 / 69)); // 1 degree latitude is approximately 69 miles
        var numVerticalSquares = Math.ceil(height / (5 / 69));

        // Calculate the dimensions of each square
        var squareWidth = width / numHorizontalSquares;
        var squareHeight = height / numVerticalSquares;

        // Loop to create squares
        for (var i = 0; i < numHorizontalSquares; i++) {
            for (var j = 0; j < numVerticalSquares; j++) {
                // Calculate coordinates for each square
                var topLeft = L.latLng(texasBounds.getNorth() - j * squareHeight, texasBounds.getWest() + i * squareWidth);
                var bottomRight = L.latLng(texasBounds.getNorth() - (j + 1) * squareHeight, texasBounds.getWest() + (i + 1) * squareWidth);
                var squareBounds = L.latLngBounds(topLeft, bottomRight);

                // Accumulate values and count data points within each square
                var totalValue = 0;
                var count = 0;
                for (var k = 0; k < dataset.length; k++) {
                    var point = dataset[k];
                    if (squareBounds.contains(L.latLng(point.lat, point.lng))) {
                        totalValue += point.value;
                        count++;
                    }
                }
                
                // Calculate average value for the square
                var averageValue = count > 0 ? totalValue / count : null;

                // Assign color based on the average value
                var color = averageValue !== null ? getColor(averageValue) : '#ffffff'; // No color if no data points in the square
                
                // Create a rectangle for each square and add to map
                L.rectangle(squareBounds, {color: color, weight: 0, fillOpacity: 0.4}).addTo(map);
            }
        }
    }
</script>

</body>
</html>
