<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Choropleth Map in Leaflet with Average</title>
    <!-- Load Leaflet from CDN -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
        #map { height: 100vh; }

        .legend {
            line-height: 18px;
            color: #555;
            background-color: white;
            padding: 10px;
            border-radius: 10px;
            border-color: black;
        }

        .legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            opacity: 0.5;
        }

        p {
            margin: 0;
            margin-bottom: 5px;
        }

    </style>
</head>
<body>

<div id="map"></div>

<script>
    // Define the bounds of Texas
    let texasBounds = L.latLngBounds(
        [25.8371, -106.6466], // Southwest coordinates of Texas
        [36.5007, -93.5083]  // Northeast coordinates of Texas
    );

    // Create a Leaflet map centered on Texas
    let map = L.map('map').fitBounds(texasBounds);

    // Add OpenStreetMap tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    // Function to parse GeoJSON data
    function parseGeoJSON(data) {
        return data.features.map(feature => ({
            lat: parseFloat(feature.geometry.coordinates[1]),
            lng: parseFloat(feature.geometry.coordinates[0]),
            value: parseFloat(feature.properties['Pressure Delta'])
        }));
    }

    // Function to fetch data from Flask route
    async function fetchData() {
        const response = await fetch('/pressure_data_13');
        const data = await response.json();
        return parseGeoJSON(data);
    }

    // Call the function to fetch data from Flask route
    fetchData()
        .then(dataset => {
            // Now you have the dataset, you can use it here
            console.log('Parsed dataset:', dataset);
            drawMapSquares(dataset);
        })
        .catch(error => {
            console.error('Error fetching data:', error);
        });

    // Function to draw 5 square mile map squares based on the dataset
    function drawMapSquares(dataset) {
        // Calculate the number of squares needed
        let width = texasBounds.getEast() - texasBounds.getWest();
        let height = texasBounds.getNorth() - texasBounds.getSouth();

        // Calculate number of squares horizontally and vertically
        let numHorizontalSquares = Math.ceil(width / (5 / 69)); // 1 degree latitude is approximately 69 miles
        let numVerticalSquares = Math.ceil(height / (5 / 69));

        // Calculate the dimensions of each square
        let squareWidth = width / numHorizontalSquares;
        let squareHeight = height / numVerticalSquares;

        // Create a dictionary to store data points for each square
        let squareData = {};

        // Iterate over each data point and assign it to the corresponding square
        dataset.forEach(point => {
            // Calculate the square index for the data point
            let xIndex = Math.floor((point.lng - texasBounds.getWest()) / squareWidth);
            let yIndex = Math.floor((texasBounds.getNorth() - point.lat) / squareHeight);
            // Create a unique key for the square
            let key = xIndex + '_' + yIndex;
            // Initialize array for the square if not exists
            if (!squareData[key]) {
                squareData[key] = [];
            }
            // Add the data point to the square
            squareData[key].push(point);
        });

        // Function to calculate color based on value
        function getColor(value) {
            return value >= 10000 ? '#33000F' :
                value >= 9000  ? '#4C0016' :
                value >= 8000  ? '#800026' :
                value >= 7000  ? '#bd0026' :
                value >= 6000  ? '#e31a1c' :
                value >= 5000  ? '#fc4e2a' :
                value >= 4000  ? '#fd8d3c' :
                value >= 3000  ? '#feb24c' :
                value >= 2000  ? '#fed976' :
                value >= 1000  ? '#ffeda0' :
                    '#ffffcc';
        }

        // Iterate over each square and draw it on the map
        Object.keys(squareData).forEach(key => {
            let points = squareData[key];
            let totalValue = points.reduce((acc, curr) => acc + curr.value, 0);
            let averageValue = totalValue / points.length;
            let color = getColor(averageValue);
            // Calculate the bounds of the square
            let xIndex = parseInt(key.split('_')[0]);
            let yIndex = parseInt(key.split('_')[1]);
            let topLeft = L.latLng(texasBounds.getNorth() - yIndex * squareHeight, texasBounds.getWest() + xIndex * squareWidth);
            let bottomRight = L.latLng(texasBounds.getNorth() - (yIndex + 1) * squareHeight, texasBounds.getWest() + (xIndex + 1) * squareWidth);
            let squareBounds = L.latLngBounds(topLeft, bottomRight);
            // Create a rectangle for the square and add to map
            L.rectangle(squareBounds, {color: color, weight: 0, fillOpacity: 0.5}).addTo(map);
        });
    }

    // ------------------------------------------------------------------------------------------------------------------------------------------------
    // LEGEND
    // ------------------------------------------------------------------------------------------------------------------------------------------------

    // create legend & add to map
    let legend = L.control({position: 'topright'});

    legend.onAdd = function (map) {

        let div = L.DomUtil.create('div', 'info legend'),
            grades = [0, 1000, 2000, 3000, 4000, 5000, 6000, 7000, 8000, 9000, 10000],
            labels = [];

        // Add title to the legend
        div.innerHTML = '<p><ins>Pore Pressure Delta</ins></p>';

        // loop through our density intervals and generate a label with a colored square for each interval
        for (let i = 0; i < grades.length; i++) {
            div.innerHTML +=
                '<i style="background:' + getColor(grades[i] + 1) + '"></i> ' +
                grades[i].toLocaleString() + (grades[i + 1] ? ' &ndash; ' + grades[i + 1].toLocaleString() + '<br>' : ' +');
        }

        return div;
    };

    legend.addTo(map);

</script>

</body>
</html>
